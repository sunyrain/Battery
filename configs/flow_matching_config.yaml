# Battery Flow Matching 配置文件
# 用于电池潜空间分布迁移模型训练
# 
# ⚠️ 重要：确保数据和归一化参数与 SelfLearning 训练一致！

# ============================================================
# 模型配置
# ============================================================
model:
  latent_dim: 256
  
  velocity_net:
    hidden_dim: 256
    time_embed_dim: 64
    cond_embed_dim: 64
    num_layers: 4
    dropout: 0.1
    use_adaln: true
    use_skip_connections: true
  
  condition:
    num_battery_types: 10
    num_c_rates: 20
    continuous_dim: 2
  
  solver:
    type: "euler"
    rtol: 1.0e-3
    atol: 1.0e-3
  
  path_type: "linear"
  lightweight: true
  
  # Cycle 范围（统一设置为100）
  max_cycle: 100
  
  # 失效阈值
  failure_threshold: 0.95

# ============================================================
# 编码器配置 (SmartWave)
# ============================================================
encoder:
  checkpoint_path: "latest.pth"
  freeze: true
  
  smartwave:
    input_dim: 1
    d_model: 256
    nhead: 4
    num_layers: 1
    ROPE_max_len: 5000
    num_classes: 4
    max_level: 6
    wavelet: "sym4"
    patch_size: 10
    stride: 10
    dropout: 0.1

# ============================================================
# 数据配置
# ============================================================
data:
  data_root: ""
  
  dataset:
    # 使用简化数据集（cycle 1-54，201 样本）
    csv_path: "Data/LiCu_10C-1/LiCu_10C_1_R_simple.csv"
    signal_length: 3000
    
    pairing:
      min_cycle_gap: 5
      max_cycle_gap: 100
      use_all_pairs: false
  
  # 潜空间缓存（使用正确归一化的缓存）
  cache:
    enabled: true
    cache_dir: "experiments/flow_matching/latent_cache_correct"
  
  # 归一化参数（来自 latest.pth，必须与训练数据一致）
  normalize:
    mean: 0.0014818326526033054
    std: 0.15278572162321524

# ============================================================
# 训练配置
# ============================================================
training:
  batch_size: 512
  num_epochs: 100
  num_workers: 0  # Windows 兼容
  
  optimizer:
    type: "adamw"
    lr: 1.0e-4
    weight_decay: 0.01
    betas: [0.9, 0.999]
  
  scheduler:
    type: "cosine"
    warmup_epochs: 5
    min_lr: 1.0e-6
  
  gradient_clip:
    enabled: true
    max_norm: 1.0
  
  ema:
    enabled: true
    decay: 0.9999
  
  checkpoint:
    save_dir: "experiments/flow_matching/checkpoints"
    save_every: 10
    keep_last: 3
  
  logging:
    log_dir: "experiments/flow_matching/logs"
    log_every: 50
    use_wandb: false

# ============================================================
# 评估配置
# ============================================================
evaluation:
  eval_every: 5
  
  trajectory:
    num_steps: 50
    visualize: true
    save_plots: true

# ============================================================
# 推理配置
# ============================================================
inference:
  num_steps: 50
  use_ema: true
  batch_size: 64

# ============================================================
# 实验配置
# ============================================================
experiment:
  name: "battery_flow_v2"
  seed: 42
  device: "cuda"
  
  mixed_precision:
    enabled: true
    dtype: "float16"
